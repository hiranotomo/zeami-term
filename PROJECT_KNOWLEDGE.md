# ZeamiTerm - プロジェクト知識ベース

## プロジェクト概要
ZeamiTermは、Claude Codeとの対話を強化するElectronベースのターミナルエミュレータです。xterm.js v5.5.0をフォークし、選択透明度問題をソースレベルで解決しています。

## 技術的な学び

### xterm.jsフォークの価値（2025-06-27）
- ソースレベルでのカスタマイズが可能
- 内部APIへの直接アクセスで、より深い統合が実現できる
- ただし、その利点を活かすには適切なアーキテクチャ設計が必要

### 選択透明度問題の解決（2025-06-26）
- xterm.jsのCSSセレクタの特異性の問題が原因
- ソースコードレベルでの修正により根本解決
- `src/browser/Linkifier.ts`と`src/browser/renderer/dom/DomRenderer.ts`を修正

## 既知の問題と対策

### 初期化時の停止問題（2025-06-28解決）
- **問題**: アプリケーションが初期化時に停止し、何も表示されない
- **原因**: IPC通信のイベントハンドラーが未登録
- **解決策**: main.jsでelectronAPIのハンドラーを正しく設定、contextBridge.exposeInMainWorldで公開したAPIに対応するipcMain.handleを実装
- **詳細**: [Initialization Fix](/docs/development/2025-06-28-initialization-fix.md)

### PTY出力表示問題（2025-06-28解決）
- **問題**: コマンド入力は受信するが、出力が表示されない
- **原因**: レンダラープロセスのIPCイベントリスナーが未設定
- **解決策**: terminal:dataイベントのリスナーを正しく設定、メインプロセスからのwebContents.send()の動作確認
- **詳細**: [PTY Output Fix](/docs/development/2025-06-28-pty-output-fix-success.md)

### コマンドシステムの混乱（2025-06-27解決）
- **問題**: 複数のコマンドインターセプト実装が競合し、カスタムコマンドが動作しない
- **原因**: メインプロセスとレンダラープロセスで重複した実装、モンキーパッチによる脆弱な設計
- **解決**: ZeamiTerminalクラスによる統一されたコマンドシステムを実装、CommandRegistryパターンの採用
- **詳細**: [Command System Unified](/docs/development/2025-06-27-command-system-unified.md)

### パフォーマンス最適化（2025-06-26）
- WebGLレンダラーの活用で高速描画を実現
- スクロール時のテクスチャアトラス最適化
- レンダーキューによる描画バッチ処理

## パターンとベストプラクティス

### アーキテクチャ設計の原則
1. **シンプルさを優先**: 複雑な解決策より、理解しやすい実装を選ぶ
2. **責任の明確化**: 各コンポーネントの役割を明確に定義
3. **拡張性の確保**: 将来の機能追加を考慮した設計
4. **クリーンアーキテクチャ**: 設定とロジックの分離、単一責任の原則
5. **イベント駆動設計**: 疎結合なコンポーネント間通信

### 開発プロセス
1. **問題の根本原因を探る**: 表面的な修正を避ける
2. **ドキュメント先行**: 実装前に設計を文書化
3. **定期的なリファクタリング**: 技術的負債の蓄積を防ぐ
4. **包括的なテスト**: ユニット・統合・E2E・パフォーマンステストの実施
5. **段階的な改善**: 完璧を求めず、実現可能な範囲で価値を提供

### Electron + xterm.js統合パターン
1. **メインプロセス**: node-ptyでシェルプロセスを管理
2. **レンダラープロセス**: xterm.jsでターミナルUI提供
3. **IPC通信**: contextIsolation: trueでセキュアな通信
4. **preloadスクリプト**: 最小限のAPIのみ公開
5. **エラーハンドリング**: 両プロセスで適切なエラー処理

### テスト戦略
1. **ユニットテスト**: 個別機能の動作検証（47ケース実装済み）
2. **統合テスト**: サービス間の連携確認
3. **E2Eテスト**: Playwrightで実際の操作をシミュレート
4. **パフォーマンステスト**: 出力・スクロール・入力の計測
5. **テストランナー**: 全テストの一括実行とレポート生成
6. **表示内容検証**: UIの存在だけでなく、実際の表示内容を検証（2025-01-21追加）

## 重要なリンク
- [開発ログ](/docs/logs/)
- [ジャーナル](/docs/journals/)
- [開発ドキュメント](/docs/development/)
- [包括的改善記録](/docs/ZEAMITERM_COMPREHENSIVE_IMPROVEMENTS.md)

## Phase 3機能の実装状況（2025-06-28）

### ✅ 実装完了機能
1. **シェル統合（ShellIntegrationAddon）**
   - OSC 133/633/1337シーケンスのサポート
   - コマンドの視覚的フィードバック
   - 実行時間の計測と表示

2. **高度なリンク検出（EnhancedLinkProvider）**
   - ファイルパス、エラーメッセージ、Git URLの検出
   - 多言語対応（TypeScript、Python、Ruby等）
   - クリック可能なリンクの生成

3. **ターミナルプロファイルシステム**
   - 複数シェルの自動検出
   - カスタムプロファイルの作成・管理
   - UIからのプロファイル切り替え

### 教訓と洞察
1. **リファクタリングの重要性**: ユーザーの厳しい批判「何のためのリファクタリングだったんだ！」から学んだクリーンコードの価値
2. **実現可能性の検証**: 理想的な設計より、実装可能で価値のある機能を優先
3. **継続的な改善**: 完璧を求めず、段階的に品質を向上させる
4. **テストの品質**: UIの存在確認だけでなく、実際の表示内容の検証が重要（2025-01-21）

## 更新履歴
- 2025-01-21: タブ・スプリット機能実装、テスト戦略の教訓を追加
- 2025-06-28: 初期化・PTY出力問題の解決、Phase 3機能実装、包括的テストの追加
- 2025-06-27: コマンドシステムの問題と再設計計画を追加
- 2025-06-26: 初版作成