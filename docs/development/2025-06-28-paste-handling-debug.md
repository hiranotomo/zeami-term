# 2025-06-28: ペースト処理のデバッグと分析

## 問題の詳細
1. 長文をペーストすると`[Pasting...]`で停止
2. `terminalId is not defined`エラーが複数箇所で発生
3. ブラケッティドペーストモードの処理が正常に動作しない

## 修正内容

### 1. terminalIdエラーの修正
- 484行目: `terminalId` → `terminalId`（引数として渡されている）
- 513行目: `terminalId` → `session.id`（sessionオブジェクトから取得）

### 2. ペースト処理の一時無効化
ブラケッティドペーストモードの処理に問題があるため、一時的に無効化：
- `_handleData`メソッド内のペースト処理をコメントアウト
- 通常の文字処理に戻す

## 調査結果

### ブラケッティドペーストモードの問題
1. **検出の問題**: `\x1b[200~`マーカーが正しく検出されない
2. **メッセージ表示**: `[Pasting...]`メッセージが画面を乱す
3. **バッファリング**: 大量データのバッファリングで処理が停止

### 可能な原因
1. **xterm.js内部処理との競合**: xterm.jsが既にブラケッティドペーストを処理している可能性
2. **Claude Codeの特殊な動作**: Claude Codeがペーストデータを特殊な方法で送信
3. **タイミング問題**: ペースト開始と終了マーカーが別々のチャンクで到着

## 今後の対応

### 短期的対応
- ペースト処理を無効化して安定性を優先
- 通常の入力処理で動作確認

### 長期的対応
1. xterm.jsのブラケッティドペーストモードAPIを調査
2. 適切なイベントハンドラーの使用
3. より堅牢なペースト処理の実装

## 学習ポイント
1. **段階的デバッグ**: 複雑な機能は一時的に無効化して問題を切り分ける
2. **スコープ管理**: コールバック内での変数スコープに注意
3. **既存機能との統合**: フレームワークの既存機能を理解してから拡張する