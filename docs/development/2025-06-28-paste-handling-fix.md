# 2025-06-28: ペースト処理のフリーズ問題修正（完全版）

## 問題の概要
ZeamiTermで長いテキストをクリップボードからペーストした際に、以下の問題が発生：
1. `ReferenceError: id is not defined`エラーが頻発
2. アプリケーションがフリーズ状態になる
3. 一文字ずつ処理されるため、パフォーマンスが極端に低下

## 原因
### 1. 未定義変数の参照
`ZeamiTermManager.js`の484行目で、`session.terminal.onData`のコールバック内で未定義の`id`変数を使用していた：
```javascript
this.sessionPersistence.saveSession(id, session.terminal, session.process);
```

### 2. ペースト処理の非効率性
- xterm.jsのブラケッティドペーストモード（`\x1b[200~`〜`\x1b[201~`）を考慮していない
- ペーストされたテキストが一文字ずつ`_handleData`で処理される
- 各文字に対してコマンド判定などの処理が実行される

## 実装した解決策

### 1. 変数名の修正
`id` → `terminalId`に修正

### 2. ペースト処理の最適化
`ZeamiTerminal.js`にブラケッティドペーストモードの完全な処理を実装：
- ペーストマーカーの部分検出（文字列分割に対応）
- ペースト開始・終了の適切な検出とバッファリング
- PTYへの正しい順序でのデータ送信

### 3. 大容量ペースト対策
- 10MBのサイズ制限を実装
- 制限超過時の適切な切り詰めとユーザー通知

### 4. ペースト状況のフィードバック
- ペースト開始時：`[Pasting...]`表示
- ペースト完了時：バイト数、行数、処理時間を表示
- 切り詰められた場合は警告表示

### 5. コピー機能の強化
- 選択テキストの自動追跡
- Ctrl+C/Cmd+Cでのクリップボードへのコピー
- 選択中のCtrl+Cはターミナルに送信しない

### 6. エラーハンドリング
- try-catchブロックで全体を保護
- ペースト関連エラーのユーザー通知

## 学んだこと

### 1. ブラケッティドペーストモードの重要性
- 大量テキストの安全な処理に必須
- エスケープシーケンスの正しい順序が重要

### 2. Electronでのクリップボード処理
- メニューでのrole設定が基本
- navigator.clipboard APIでのプログラマティックな制御
- セキュリティ制約への配慮

### 3. パフォーマンス最適化
- 文字単位処理からバッチ処理への移行
- 適切なバッファリングとメモリ管理
- ユーザーフィードバックの重要性

### 4. UTF-8境界問題
- xterm.jsは内部で適切に処理
- 基本的な対策で十分な場合が多い

## 影響範囲
- 大量のテキストペースト時のパフォーマンスが大幅に改善
- エラーログが解消され、安定性が向上
- Claude Codeとの対話で長いプロンプトを使用可能に
- コピー・ペースト体験の向上

## 今後の可能性
- ペースト内容のプレビュー機能
- ペースト履歴の管理
- 特殊文字のサニタイズオプション
- より高度なUTF-8境界処理