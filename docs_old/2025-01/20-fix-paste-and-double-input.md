# 2025-01-20: ペースト処理と二重入力問題の修正

## 発生した問題
1. **二重入力**: ターミナルに入力した文字が二重で表示される
2. **ペーストスタック**: 長文ペースト時に「Pasting text...」で止まる

## 根本原因

### 1. 二重入力の原因
- `ptyConfig.js`で`echo: true`が設定されていた
- xterm.jsは既にローカルエコーを処理するため、PTYのエコーと重複

### 2. ペーストスタックの原因
- 私が追加したペースト処理がClaude Codeの内部処理と競合
- Claude Codeは独自のペースト処理を持っており、外部からの介入を期待していない
- ブラケットペーストモードのマーカー処理が二重になっていた

## 解決策

### 1. PTYエコーの無効化
```javascript
// ptyConfig.js
echo: false,  // Disable echo to prevent double input (xterm.js handles local echo)
```

### 2. ペースト処理の削除
- ZeamiTerminal.jsのペースト検出・処理を完全に削除
- 全てのデータをそのままPTYに渡すよう元に戻した
- FlowControllerのペーストモード検出も削除

### 3. 設計原則の再確認
- **非介入原則**: Claude Codeの内部処理に介入しない
- **単純性**: データはそのまま透過的に転送
- **互換性**: Claude Codeの期待する動作を尊重

## 教訓
1. **既存の分析を無視しない**: `PASTE_MODE_BEHAVIOR.md`に既に解決策が文書化されていた
2. **過度な最適化を避ける**: Claude Codeは既に最適化されている
3. **エコーシステムを理解する**: 各コンポーネントの責任範囲を明確に

## 結果
- 二重入力問題が解決
- ペースト処理が正常に動作
- Claude Codeとの互換性が保たれる